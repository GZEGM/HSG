<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DIENKON HSG Code Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- PrismJS - Syntax Highlighting -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-pascal.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap");

      body {
        font-family: "Inter", sans-serif;
        overflow: hidden;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      pre[class*="language-"] {
        margin: 0 !important;
        border-radius: 0 !important;
        background: #0f172a !important;
        height: 100%;
      }
      code[class*="language-"] {
        font-family: "Fira Code", monospace !important;
        font-size: 14px !important;
        line-height: 1.6 !important;
      }

      .loader {
        border-top-color: #6366f1;
        animation: spinner 0.8s ease-in-out infinite;
      }
      @keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .tree-item-active {
        background-color: #eef2ff;
        color: #4338ca;
        font-weight: 600;
        border-right: 3px solid #4338ca;
      }

      /* Fix Terminal visibility */
      #admin-console {
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform: translateY(110%); /* Đẩy hẳn xuống dưới */
        backdrop-filter: blur(12px);
        visibility: hidden; /* Ẩn hoàn toàn khi không dùng */
      }
      #admin-console.active {
        transform: translateY(0);
        visibility: visible;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
      }
      .status-online {
        background-color: #10b981;
        box-shadow: 0 0 10px #10b981;
      }
      .status-warning {
        background-color: #f59e0b;
        box-shadow: 0 0 10px #f59e0b;
      }
      .status-offline {
        background-color: #ef4444;
        box-shadow: 0 0 10px #ef4444;
      }

      #context-menu {
        display: none;
        position: fixed;
        z-index: 1000;
        min-width: 220px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid #e2e8f0;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        border-radius: 14px;
        padding: 8px;
      }
      .menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        font-size: 13px;
        font-weight: 500;
        color: #475569;
        cursor: pointer;
        border-radius: 10px;
        transition: all 0.2s;
      }
      .menu-item:hover {
        background: #4f46e5;
        color: white;
      }
      .item-hidden-admin {
        opacity: 0.5;
        filter: grayscale(0.8);
        background: #fff1f2 !important;
        border: 1px dashed #fda4af !important;
      }

      .shake {
        animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) both;
      }
      @keyframes shake {
        10%,
        90% {
          transform: translate3d(-1px, 0, 0);
        }
        20%,
        80% {
          transform: translate3d(2px, 0, 0);
        }
        30%,
        50%,
        70% {
          transform: translate3d(-4px, 0, 0);
        }
        40%,
        60% {
          transform: translate3d(4px, 0, 0);
        }
      }
    </style>
  </head>
  <body
    class="bg-slate-50 text-slate-900 selection:bg-indigo-100"
    oncontextmenu="return false;"
  >
    <!-- Context Menu -->
    <div id="context-menu">
      <div
        class="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase border-b border-slate-100 mb-1 truncate"
        id="menu-target-name"
      >
        ...
      </div>
      <div class="menu-item" onclick="adminAction('rename')">
        <i data-lucide="edit-3" size="14"></i> Đổi tên
      </div>
      <div class="menu-item" onclick="adminAction('note')">
        <i data-lucide="message-square" size="14"></i> Ghi chú
      </div>
      <div
        class="menu-item border-t border-slate-100 my-1 pt-1"
        onclick="adminAction('toggle')"
      >
        <i data-lucide="eye-off" size="14" id="toggle-icon"></i>
        <span id="toggle-text">Ẩn/Hiện</span>
      </div>
    </div>

    <!-- Loading -->
    <div
      id="loading-overlay"
      class="fixed inset-0 z-[100] bg-slate-900 flex items-center justify-center"
    >
      <div class="text-center">
        <div
          class="loader w-16 h-16 border-4 border-slate-700 rounded-full mx-auto mb-6"
        ></div>
        <p
          class="text-indigo-400 font-mono tracking-widest uppercase animate-pulse"
        >
          Initializing DIENKON OS...
        </p>
      </div>
    </div>

    <!-- Header -->
    <header
      class="bg-slate-900 text-white shadow-2xl relative z-50 border-b border-slate-800"
    >
      <div
        class="max-w-[1800px] mx-auto px-6 py-3 flex flex-col md:flex-row justify-between items-center gap-4"
      >
        <div
          class="flex items-center gap-4 cursor-pointer group"
          onclick="goHome()"
        >
          <div
            class="p-2.5 bg-indigo-600 rounded-2xl group-hover:rotate-12 transition-transform shadow-xl shadow-indigo-500/20"
          >
            <i data-lucide="zap" size="24" class="fill-white"></i>
          </div>
          <div>
            <h1 class="text-xl font-black tracking-tighter leading-none italic">
              DIENKON <span class="text-indigo-400 font-light">HSG</span>
            </h1>
            <span
              class="text-[9px] text-slate-500 font-mono tracking-[0.2em] uppercase"
              >Core Data Center</span
            >
          </div>
        </div>

        <div class="relative w-full md:w-[500px]">
          <i
            data-lucide="search"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"
            size="18"
          ></i>
          <input
            type="text"
            id="search-input"
            placeholder="Tìm kiếm bài tập (Ctrl + K)"
            class="w-full bg-slate-800/50 border border-slate-700 text-white placeholder-slate-500 rounded-2xl py-2.5 pl-11 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 text-sm transition-all focus:bg-slate-800"
            oninput="handleSearch(this.value)"
          />
        </div>

        <div class="flex items-center gap-6">
          <div
            id="api-status"
            class="hidden md:flex items-center gap-3 px-4 py-2 bg-slate-800/50 rounded-2xl border border-slate-700"
          >
            <span class="status-dot status-offline" id="status-dot"></span>
            <span class="text-[11px] font-mono text-slate-400" id="status-text"
              >CONNECTING...</span
            >
          </div>
          <button
            onclick="toggleAdminPanel()"
            class="p-3 hover:bg-indigo-600 rounded-2xl transition-all group shadow-lg"
            title="Terminal (`)"
          >
            <i
              data-lucide="terminal"
              size="20"
              class="text-slate-400 group-hover:text-white"
            ></i>
          </button>
        </div>
      </div>
    </header>

    <main
      class="max-w-[1800px] mx-auto flex h-[calc(100vh-72px)] overflow-hidden"
    >
      <!-- Sidebar -->
      <aside
        class="w-80 bg-white border-r border-slate-200 flex flex-col flex-shrink-0 transition-all duration-300 overflow-hidden"
        id="sidebar"
      >
        <div
          class="p-5 flex justify-between items-center border-b border-slate-50"
        >
          <span
            class="text-[10px] font-black uppercase tracking-[0.15em] text-slate-400 flex items-center gap-2"
          >
            <i data-lucide="box" size="14"></i> Explorer
          </span>
          <div class="flex gap-1">
            <button
              onclick="renderGridView()"
              class="p-2 hover:bg-indigo-50 text-indigo-600 rounded-xl transition-colors"
              title="Grid View"
            >
              <i data-lucide="layout-grid" size="16"></i>
            </button>
          </div>
        </div>
        <div
          id="tree-container"
          class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-0.5"
        ></div>
      </aside>

      <!-- Content -->
      <section
        id="content-area"
        class="flex-1 overflow-y-auto bg-slate-50 custom-scrollbar relative"
      >
        <div id="main-view" class="p-8 h-full min-h-full"></div>
      </section>
    </main>

    <!-- Admin Console -->
    <div
      id="admin-console"
      class="fixed bottom-4 left-4 right-4 z-[100] bg-slate-900/95 text-slate-300 font-mono text-sm rounded-3xl border border-slate-700 shadow-2xl overflow-hidden max-w-5xl mx-auto h-[450px] flex flex-col"
    >
      <div
        class="px-6 py-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50"
      >
        <div class="flex items-center gap-3">
          <div class="flex gap-1.5">
            <div class="w-3 h-3 rounded-full bg-rose-500"></div>
            <div class="w-3 h-3 rounded-full bg-amber-500"></div>
            <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
          </div>
          <span
            class="text-xs font-bold text-slate-500 ml-4 flex items-center gap-2 uppercase tracking-widest"
          >
            <i data-lucide="command" size="14"></i> DIENKON Terminal
          </span>
        </div>
        <div class="flex gap-4 items-center">
          <span
            id="admin-indicator"
            class="text-[10px] border border-slate-700 px-3 py-1 rounded-full text-slate-500"
            >USER SESSION</span
          >
          <button
            onclick="toggleAdminPanel()"
            class="text-slate-500 hover:text-white transition-colors p-1"
          >
            <i data-lucide="minimize-2" size="18"></i>
          </button>
        </div>
      </div>

      <div
        id="admin-output"
        class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-2 text-[13px] leading-relaxed"
      >
        <div
          class="text-indigo-400 font-bold mb-2 uppercase tracking-tighter text-lg"
        >
          DIENKON OS v2.1.0
        </div>
        <div class="text-slate-500 italic">
          Hệ thống sẵn sàng. Gõ 'help' để xem danh sách lệnh.
        </div>
      </div>

      <div class="p-4 bg-black/30 backdrop-blur-md border-t border-slate-800">
        <div
          class="flex items-center gap-4 px-4 py-3 bg-slate-800/50 rounded-2xl border border-slate-700 group focus-within:border-indigo-500/50 transition-all"
        >
          <span class="text-indigo-500 font-bold animate-pulse">❯</span>
          <input
            type="text"
            id="admin-input"
            class="bg-transparent border-none outline-none flex-1 text-emerald-400 placeholder-slate-600"
            placeholder="Type command..."
            onkeydown="processAdminCmd(event)"
            autocomplete="off"
          />
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
        update,
      } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

      // --- CONFIGURATION ---
      const GITHUB_TOKEN = "REPLACE_WITH_GITHUB_TOKEN"; // DÁN TOKEN CỦA BẠN VÀO ĐÂY ĐỂ TĂNG LIMIT API
      const REPO_OWNER = "GZEGM";
      const REPO_NAME = "HSG";

      const firebaseConfig = {
        apiKey: "AIzaSyBaPEVL-vA3YGI7f0pWrszLYyrxNjYtyE4",
        authDomain: "code-cacd4.firebaseapp.com",
        databaseURL: "https://code-cacd4-default-rtdb.firebaseio.com",
        projectId: "code-cacd4",
        storageBucket: "code-cacd4.firebasestorage.app",
        messagingSenderId: "296730554282",
        appId: "1:296730554282:web:8e60bc405e0e19cb9885d3",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const rtdb = getDatabase(app);
      const appId =
        typeof __app_id !== "undefined" ? __app_id : "dienkon-hsg-rtdb";

      function safeBtoA(str) {
        return btoa(unescape(encodeURIComponent(str)));
      }

      let rawData = [];
      let fileList = [];
      let adminSettings = {};
      let isAdmin = false;
      let currentPath = "";
      let expandedNodes = { Root: true };
      let contextTarget = null;
      let searchKeyword = "";
      let history = [];
      let historyIdx = -1;
      window.startTime = Date.now();

      // Init Firebase
      function initSync() {
        signInAnonymously(auth).then(() => {
          const settingsRef = ref(rtdb, `artifacts/${appId}/settings`);
          onValue(settingsRef, (snapshot) => {
            adminSettings = snapshot.val() || {};
            renderTree();
            refreshCurrentView();
          });
        });
      }

      function logToAdmin(msg, color = "text-slate-300", icon = "") {
        const out = document.getElementById("admin-output");
        if (out) {
          const time = new Date().toLocaleTimeString("en-US", {
            hour12: false,
          });
          out.innerHTML += `<div class="${color} flex items-start gap-2">
            <span class="text-[10px] text-slate-600 mt-1 font-mono">[${time}]</span>
            <span>${
              icon
                ? `<i data-lucide="${icon}" size="14" class="inline mr-1"></i>`
                : ""
            }${msg}</span>
          </div>`;
          out.scrollTop = out.scrollHeight;
          lucide.createIcons();
        }
      }

      async function ghFetch(url) {
        const headers = {};
        if (GITHUB_TOKEN) {
          headers["Authorization"] = `token ${GITHUB_TOKEN}`;
        }

        const res = await fetch(url, { headers });
        const rem = res.headers.get("x-ratelimit-remaining");
        const lim = res.headers.get("x-ratelimit-limit");

        if (rem) {
          const statusTxt = document.getElementById("status-text");
          statusTxt.innerText = `API: ${rem}/${lim}`;
          const ratio = parseInt(rem) / parseInt(lim);
          document.getElementById("status-dot").className = `status-dot ${
            ratio > 0.3
              ? "status-online"
              : ratio > 0.05
              ? "status-warning"
              : "status-offline"
          }`;
        }
        return res.json();
      }

      window.initApp = async function () {
        document.getElementById("loading-overlay").classList.remove("hidden");
        try {
          const data = await ghFetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/main?recursive=1`
          );
          rawData = data.tree || [];
          fileList = rawData.filter(
            (i) => i.type === "blob" && isCodeFile(i.path)
          );
          renderTree();
          renderDashboard();
          setTimeout(
            () =>
              document
                .getElementById("loading-overlay")
                .classList.add("hidden"),
            1000
          );
        } catch (e) {
          document.getElementById(
            "loading-overlay"
          ).innerHTML = `<div class='text-center p-10 bg-slate-900 h-full w-full flex flex-col items-center justify-center'><h2 class='text-rose-500 font-bold mb-4'>GitHub API Error</h2><p class='text-slate-500 mb-6'>Limit reached or network error.</p><button class='bg-indigo-600 px-6 py-2 rounded-xl text-white' onclick='location.reload()'>Thử lại</button></div>`;
        }
      };

      function isCodeFile(path) {
        return [
          "cpp",
          "py",
          "pas",
          "java",
          "c",
          "js",
          "md",
          "txt",
          "sql",
        ].includes(path.split(".").pop().toLowerCase());
      }

      function isPathVisible(fullPath) {
        if (isAdmin) return true;
        const parts = fullPath.split("/");
        let checkPath = "";
        for (let i = 0; i < parts.length; i++) {
          checkPath += (i === 0 ? "" : "/") + parts[i];
          if (adminSettings[safeBtoA(checkPath)]?.hidden === true) return false;
        }
        return true;
      }

      function isItemHidden(path) {
        return adminSettings[safeBtoA(path)]?.hidden === true;
      }

      function renderTree() {
        const container = document.getElementById("tree-container");
        if (!container) return;
        const treeRoot = { name: "Root", path: "", type: "tree", children: [] };
        rawData.forEach((item) => {
          if (!isPathVisible(item.path)) return;
          const pathParts = item.path.split("/");
          let curr = treeRoot;
          pathParts.forEach((part, idx) => {
            let found = curr.children.find((c) => c.originalName === part);
            if (!found) {
              const fullPath = pathParts.slice(0, idx + 1).join("/");
              const node = {
                name: adminSettings[safeBtoA(fullPath)]?.alias || part,
                originalName: part,
                path: fullPath,
                type: idx === pathParts.length - 1 ? item.type : "tree",
                children: [],
              };
              curr.children.push(node);
              found = node;
            }
            curr = found;
          });
        });

        function buildHTML(node, level = 0) {
          if (node.name === "Root" && level === 0)
            return node.children
              .sort((a, b) => (a.type === "tree" ? -1 : 1))
              .map((c) => buildHTML(c, level))
              .join("");

          const isFolder = node.type === "tree";
          const isExp = expandedNodes[node.path];
          const hidden = isItemHidden(node.path);
          const padding = level * 12 + 12;

          return `
            <div class="tree-item group ${
              isAdmin && hidden ? "item-hidden-admin" : ""
            }" 
                 oncontextmenu="handleRightClick(event, '${node.path}')">
              <div onclick="${
                isFolder
                  ? `toggleNode('${node.path}')`
                  : `viewFile('${node.path}')`
              }" 
                   class="flex items-center py-2 px-3 rounded-xl cursor-pointer hover:bg-slate-100 text-[13px] transition-all truncate ${
                     currentPath === node.path
                       ? "tree-item-active shadow-sm"
                       : "text-slate-600"
                   }"
                   style="padding-left: ${padding}px">
                <i data-lucide="${
                  isFolder
                    ? isExp
                      ? "chevron-down"
                      : "chevron-right"
                    : "file-code-2"
                }" size="14" class="mr-2 opacity-40"></i>
                <i data-lucide="${
                  isFolder ? (isExp ? "folder-open" : "folder") : ""
                }" size="14" class="mr-2 text-indigo-500 ${
            !isFolder ? "hidden" : ""
          }"></i>
                <span class="truncate flex-1">${node.name}</span>
              </div>
              ${
                isFolder && isExp
                  ? `<div>${node.children
                      .sort((a, b) => (a.type === "tree" ? -1 : 1))
                      .map((c) => buildHTML(c, level + 1))
                      .join("")}</div>`
                  : ""
              }
            </div>`;
        }
        container.innerHTML = buildHTML(treeRoot);
        lucide.createIcons();
      }

      window.viewFile = async function (path, loadContent = true) {
        if (!isPathVisible(path)) {
          goHome();
          return;
        }
        currentPath = path;
        const key = safeBtoA(path);
        const name = adminSettings[key]?.alias || path.split("/").pop();
        const note = adminSettings[key]?.note || "";
        const hidden = isItemHidden(path);

        const view = document.getElementById("main-view");
        view.innerHTML = `
          <div class="h-full flex flex-col bg-white rounded-[2rem] shadow-2xl border border-slate-200 overflow-hidden" oncontextmenu="handleRightClick(event, '${path}')">
            <div class="px-8 py-6 border-b border-slate-100 flex justify-between items-center bg-white/50 backdrop-blur-xl">
              <div class="flex items-center gap-6">
                <button onclick="goHome()" class="p-3 hover:bg-slate-100 rounded-2xl transition-all"><i data-lucide="arrow-left" size="20"></i></button>
                <div>
                  <h2 class="font-black text-slate-800 text-xl flex items-center gap-3">
                    ${name} ${
          isAdmin && hidden
            ? '<span class="text-[10px] bg-rose-500 text-white px-3 py-1 rounded-full font-mono uppercase tracking-widest">Hidden</span>'
            : ""
        }
                  </h2>
                  <p class="text-[10px] font-mono text-slate-400 uppercase tracking-[0.2em] mt-1">${path}</p>
                </div>
              </div>
              <div class="flex gap-3">
                <button onclick="copyToClipboard()" id="copy-btn" class="text-xs font-bold bg-slate-900 text-white px-6 py-3 rounded-2xl flex items-center gap-2 hover:bg-indigo-600 transition-all shadow-xl shadow-slate-200"><i data-lucide="copy" size="14"></i> COPY CODE</button>
              </div>
            </div>
            ${
              note
                ? `<div class="bg-indigo-50/50 px-8 py-4 border-b border-indigo-100 text-[13px] text-indigo-900 flex items-center gap-3 italic"><i data-lucide="info" size="16" class="text-indigo-500"></i> Note: ${note}</div>`
                : ""
            }
            <div class="flex-1 relative bg-[#0f172a] overflow-hidden">
              <div id="file-loader" class="absolute inset-0 z-20 flex items-center justify-center bg-[#0f172a]"><div class="loader w-10 h-10 border-2 border-indigo-500 rounded-full"></div></div>
              <pre class="language-${getPrismLang(
                path.split(".").pop()
              )} h-full overflow-auto custom-scrollbar p-8"><code></code></pre>
            </div>
          </div>`;
        lucide.createIcons();

        if (loadContent) {
          try {
            const data = await ghFetch(
              `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${path}`
            );
            const content = decodeURIComponent(escape(atob(data.content)));
            window.currentCode = content;
            const codeBox = document.querySelector("pre code");
            if (codeBox) {
              codeBox.textContent = content;
              Prism.highlightElement(codeBox);
              document.getElementById("file-loader")?.remove();
            }
          } catch (e) {
            logToAdmin("Error loading file.", "text-rose-400");
          }
        }
      };

      window.renderGridView = function () {
        currentPath = "grid";
        const view = document.getElementById("main-view");
        const filtered = fileList.filter((f) => {
          if (!isPathVisible(f.path)) return false;
          return f.path.toLowerCase().includes(searchKeyword.toLowerCase());
        });

        view.innerHTML = `
          <div class="space-y-10 pb-20 max-w-7xl mx-auto">
            <div>
               <h1 class="text-4xl font-black text-slate-900 uppercase tracking-tighter italic">Library <span class="text-indigo-600 font-light not-italic">Files</span></h1>
               <p class="text-slate-500 mt-2 font-medium">Found ${
                 filtered.length
               } resources</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
              ${filtered
                .map((f) => {
                  const name =
                    adminSettings[safeBtoA(f.path)]?.alias ||
                    f.path.split("/").pop();
                  const hidden = isItemHidden(f.path);
                  const ext = f.path.split(".").pop().toUpperCase();
                  return `
                  <div onclick="viewFile('${
                    f.path
                  }')" oncontextmenu="handleRightClick(event, '${f.path}')" 
                       class="bg-white p-7 rounded-[2rem] border border-slate-200 hover:border-indigo-500 hover:shadow-2xl transition-all cursor-pointer group flex flex-col h-full relative overflow-hidden ${
                         isAdmin && hidden ? "item-hidden-admin" : ""
                       }">
                    <div class="absolute top-0 right-0 p-3 bg-slate-50 rounded-bl-2xl font-mono text-[10px] text-slate-400 font-bold">${ext}</div>
                    <div class="flex flex-col gap-4">
                      <div class="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center group-hover:bg-indigo-50 group-hover:scale-110 transition-all">
                        <i data-lucide="file-code" size="24" class="text-slate-400 group-hover:text-indigo-600"></i>
                      </div>
                      <div class="truncate">
                        <h4 class="font-bold text-slate-800 text-base truncate group-hover:text-indigo-600">${name}</h4>
                        <p class="text-[10px] text-slate-400 font-mono mt-1 truncate">${
                          f.path
                        }</p>
                      </div>
                    </div>
                  </div>`;
                })
                .join("")}
            </div>
          </div>`;
        lucide.createIcons();
      };

      window.renderDashboard = () => {
        currentPath = "";
        const v = document.getElementById("main-view");
        v.innerHTML = `<div class="flex flex-col items-center justify-center min-h-full text-center p-10"><div class="w-28 h-28 bg-indigo-600 text-white rounded-[3rem] flex items-center justify-center shadow-[0_20px_50px_rgba(79,70,229,0.3)] mb-10 animate-bounce"><i data-lucide="zap" size="56" class="fill-white"></i></div><h1 class="text-6xl font-black text-slate-900 mb-6 uppercase tracking-tighter">DIENKON HUB</h1><p class="text-slate-500 mb-10 max-w-lg text-lg leading-relaxed">Hệ thống lưu trữ và quản lý tài liệu mã nguồn HSG. Bảo mật, đồng bộ và chuyên nghiệp.</p><div class="flex gap-4"><button onclick="renderGridView()" class="bg-indigo-600 text-white px-12 py-5 rounded-[1.5rem] font-black text-lg hover:scale-105 transition-all shadow-xl shadow-indigo-100 uppercase tracking-widest">Khám phá</button><button onclick="toggleAdminPanel()" class="bg-slate-900 text-white px-12 py-5 rounded-[1.5rem] font-black text-lg hover:bg-slate-800 transition-all uppercase tracking-widest">Terminal</button></div></div>`;
        lucide.createIcons();
      };

      // --- ADMIN ACTION ---
      window.handleRightClick = (e, path) => {
        if (!isAdmin) return;
        e.preventDefault();
        e.stopPropagation();
        contextTarget = path;
        const menu = document.getElementById("context-menu");
        const hidden = isItemHidden(path);
        document.getElementById("menu-target-name").innerText = path
          .split("/")
          .pop();
        document.getElementById("toggle-text").innerText = hidden
          ? "Show to Public"
          : "Hide from Public";
        document
          .getElementById("toggle-icon")
          .setAttribute("data-lucide", hidden ? "eye" : "eye-off");
        lucide.createIcons();
        menu.style.display = "block";
        menu.style.left = `${e.pageX}px`;
        menu.style.top = `${e.pageY}px`;
      };

      window.adminAction = async (action) => {
        if (!contextTarget) return;
        const key = safeBtoA(contextTarget);
        let settings = adminSettings[key] || {};
        if (action === "rename") {
          const val = prompt("New alias:", settings.alias || "");
          if (val !== null) settings.alias = val;
        } else if (action === "note") {
          const val = prompt("Note:", settings.note || "");
          if (val !== null) settings.note = val;
        } else if (action === "toggle") {
          settings.hidden = !settings.hidden;
          logToAdmin(
            `${settings.hidden ? "HIDDEN" : "VISIBLE"}: ${contextTarget}`,
            settings.hidden ? "text-rose-400" : "text-emerald-400"
          );
        }
        const updates = {};
        updates[`artifacts/${appId}/settings/${key}`] = settings;
        await update(ref(rtdb), updates);
      };

      // --- TERMINAL CMD ---
      window.processAdminCmd = (e) => {
        if (e.key === "ArrowUp") {
          if (historyIdx < history.length - 1) {
            historyIdx++;
            e.target.value = history[history.length - 1 - historyIdx];
          }
          return;
        }
        if (e.key === "ArrowDown") {
          if (historyIdx > 0) {
            historyIdx--;
            e.target.value = history[history.length - 1 - historyIdx];
          } else {
            historyIdx = -1;
            e.target.value = "";
          }
          return;
        }
        if (e.key !== "Enter") return;

        const input = e.target.value.trim();
        e.target.value = "";
        historyIdx = -1;
        if (!input) return;
        history.push(input);
        logToAdmin(input, "text-indigo-400 font-bold", "chevron-right");

        const args = input.toLowerCase().split(" ");
        const cmd = args[0];

        switch (cmd) {
          case "help":
            logToAdmin("--- COMMANDS ---", "text-indigo-500");
            logToAdmin("admin : Toggle privileges", "text-slate-400");
            logToAdmin("stats : File analysis", "text-slate-400");
            logToAdmin("uptime: Session time", "text-slate-400");
            logToAdmin("ping  : Connection check", "text-slate-400");
            logToAdmin("ver   : OS version", "text-slate-400");
            logToAdmin("matrix: Matrix mode", "text-slate-400");
            logToAdmin("shake : Shake effect", "text-slate-400");
            logToAdmin("joke  : Dev joke", "text-slate-400");
            logToAdmin("whoami: Identity", "text-slate-400");
            logToAdmin("cls   : Clear terminal", "text-slate-400");
            break;

          case "admin":
            isAdmin = !isAdmin;
            const ind = document.getElementById("admin-indicator");
            ind.innerText = isAdmin ? "ADMIN SESSION" : "USER SESSION";
            ind.className = isAdmin
              ? "text-[10px] border border-indigo-500 px-3 py-1 rounded-full text-indigo-400 font-bold"
              : "text-[10px] border border-slate-700 px-3 py-1 rounded-full text-slate-500";
            logToAdmin(
              `Privileges: ${isAdmin ? "ADMIN" : "USER"}`,
              isAdmin ? "text-emerald-400" : "text-rose-400"
            );
            renderTree();
            refreshCurrentView();
            break;

          case "stats":
            const st = {};
            fileList.forEach((f) => {
              const ex = f.path.split(".").pop();
              st[ex] = (st[ex] || 0) + 1;
            });
            logToAdmin("File Analysis:", "text-indigo-400");
            Object.entries(st).forEach(([k, v]) =>
              logToAdmin(`- .${k.toUpperCase()}: ${v}`)
            );
            break;

          case "uptime":
            logToAdmin(
              `Uptime: ${Math.floor((Date.now() - window.startTime) / 1000)}s`
            );
            break;

          case "ping":
            logToAdmin("PONG! " + Math.floor(Math.random() * 50 + 10) + "ms");
            break;
          case "ver":
            logToAdmin("DIENKON OS v2.1.0 Cloud");
            break;
          case "whoami":
            logToAdmin(`Session User: ${isAdmin ? "Root" : "Guest"}`);
            break;
          case "cls":
          case "clear":
            document.getElementById("admin-output").innerHTML = "";
            break;
          case "shake":
            document.body.classList.add("shake");
            setTimeout(() => document.body.classList.remove("shake"), 500);
            break;
          case "joke":
            logToAdmin("Programmer: A machine that turns caffeine into code.");
            break;
          case "matrix":
            document.body.classList.toggle("matrix-mode");
            break;
          case "exit":
            toggleAdminPanel();
            break;
          default:
            logToAdmin(`Unknown command: ${cmd}`);
        }
      };

      function refreshCurrentView() {
        if (currentPath === "grid") renderGridView();
        else if (currentPath && currentPath !== "")
          viewFile(currentPath, false);
      }

      function getPrismLang(ext) {
        const m = {
          cpp: "cpp",
          py: "python",
          pas: "pascal",
          java: "java",
          js: "javascript",
          sql: "sql",
          c: "c",
        };
        return m[ext] || "clike";
      }

      window.toggleAdminPanel = () => {
        const console = document.getElementById("admin-console");
        console.classList.toggle("active");
      };

      window.toggleNode = (path) => {
        expandedNodes[path] = !expandedNodes[path];
        renderTree();
      };
      window.goHome = () => {
        currentPath = "";
        renderDashboard();
        renderTree();
      };
      window.handleSearch = (v) => {
        searchKeyword = v;
        if (currentPath === "grid") renderGridView();
      };
      window.copyToClipboard = () => {
        const ta = document.createElement("textarea");
        ta.value = window.currentCode || "";
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        const b = document.getElementById("copy-btn");
        b.innerText = "COPIED!";
        setTimeout(() => (b.innerText = "COPY CODE"), 2000);
      };

      document.addEventListener(
        "click",
        () => (document.getElementById("context-menu").style.display = "none")
      );
      document.addEventListener("keydown", (e) => {
        if (e.ctrlKey && e.key === "k") {
          e.preventDefault();
          document.getElementById("search-input").focus();
        }
        if (e.key === "`") {
          e.preventDefault();
          toggleAdminPanel();
        }
      });

      initSync();
      initApp();
    </script>
  </body>
</html>
