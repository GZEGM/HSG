<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GZEGM HSG Code Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 10px;
      }
      .tab-size-4 {
        tab-size: 4;
      }
      .loader {
        border-top-color: #4338ca;
        animation: spinner 0.6s linear infinite;
      }
      @keyframes spinner {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900 selection:bg-indigo-100">
    <!-- Loading Overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 z-[100] bg-slate-50 flex items-center justify-center"
    >
      <div class="text-center">
        <div
          class="loader w-12 h-12 border-4 border-slate-200 rounded-full mx-auto mb-4"
        ></div>
        <p class="text-slate-600 font-medium animate-pulse" id="loading-text">
          Đang tải toàn bộ dữ liệu từ GZEGM/HSG...
        </p>
        <p class="text-xs text-slate-400 mt-2" id="api-status">
          Đang kết nối GitHub API (Rate Limit: 5000/h)...
        </p>
      </div>
    </div>

    <!-- Header -->
    <header class="bg-indigo-700 text-white shadow-lg sticky top-0 z-50">
      <div
        class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4"
      >
        <div
          class="flex items-center gap-3 cursor-pointer group"
          onclick="goHome()"
        >
          <div
            class="p-2 bg-white/20 rounded-lg group-hover:bg-white/30 transition-colors"
          >
            <i data-lucide="code" size="28"></i>
          </div>
          <div>
            <h1 class="text-xl font-bold tracking-tight">GZEGM / HSG</h1>
            <p class="text-xs text-indigo-100 italic">Code Explorer Pro</p>
          </div>
        </div>

        <div class="relative w-full md:w-96">
          <i
            data-lucide="search"
            class="absolute left-3 top-1/2 -translate-y-1/2 text-indigo-300"
            size="18"
          ></i>
          <input
            type="text"
            id="search-input"
            placeholder="Tìm theo tên bài hoặc thư mục..."
            class="w-full bg-indigo-800/50 border border-indigo-500 text-white placeholder-indigo-300 rounded-full py-2.5 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-white/40 transition-all shadow-inner"
            oninput="handleSearch(this.value)"
          />
        </div>

        <div class="flex items-center gap-3">
          <div
            id="rate-limit-badge"
            class="hidden md:flex items-center gap-2 bg-indigo-900/50 px-3 py-1.5 rounded-lg text-[10px] font-mono border border-indigo-400/30"
          >
            <span class="text-indigo-300">API:</span>
            <span id="rate-remaining" class="text-green-400 font-bold"
              >---</span
            >
          </div>
          <a
            href="https://github.com/GZEGM/HSG"
            target="_blank"
            class="flex items-center gap-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full text-sm font-medium transition-all"
          >
            <i data-lucide="github" size="18"></i> <span>Repo</span>
          </a>
        </div>
      </div>
    </header>

    <main
      class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-8"
    >
      <!-- Sidebar -->
      <aside class="lg:col-span-3 space-y-6">
        <div class="bg-white rounded-2xl shadow-sm p-6 border border-slate-200">
          <div
            class="flex items-center gap-2 mb-4 text-slate-800 font-semibold"
          >
            <i data-lucide="filter" class="text-indigo-500" size="18"></i>
            <span>Phân loại thư mục</span>
          </div>
          <div
            id="category-list"
            class="space-y-1 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar"
          >
            <!-- Categories will be injected here -->
          </div>
        </div>

        <div
          class="bg-gradient-to-br from-indigo-600 to-indigo-800 p-6 rounded-2xl text-white shadow-md"
        >
          <i data-lucide="zap" class="mb-3 text-yellow-300"></i>
          <h3 class="font-bold text-lg mb-1">Premium Access</h3>
          <p class="text-xs text-indigo-100 leading-relaxed opacity-90">
            Đã kích hoạt GitHub Token. Bạn có thể thoải mái duyệt hàng nghìn
            file mà không lo bị chặn IP.
          </p>
        </div>
      </aside>

      <!-- Content Section -->
      <section id="main-content" class="lg:col-span-9 min-h-[60vh]">
        <!-- Content will be injected here -->
      </section>
    </main>

    <footer class="mt-20 border-t border-slate-200 py-12 bg-white text-center">
      <p class="text-slate-500 text-sm font-medium">
        © 2025 GZEGM / HSG Code Explorer (Authenticated).
      </p>
    </footer>

    <script>
      // THAY THẾ TOKEN CỦA BẠN VÀO ĐÂY NẾU KHÔNG DÙNG BIẾN MÔI TRƯỜNG
      // Lưu ý: Bảo mật Token này, không nên push code có token lên repo công khai.
      // Dán token vào đây nếu chạy local
      //   import { GITHUB_TOKEN } from "./.env";

      const GITHUB_TOKEN = "REPLACE_WITH_GITHUB_TOKEN";

      const REPO_OWNER = "GZEGM";
      const REPO_NAME = "HSG";

      // Header cấu hình xác thực
      const getHeaders = () => {
        const headers = {
          Accept: "application/vnd.github.v3+json",
        };
        if (GITHUB_TOKEN) {
          headers["Authorization"] = `token ${GITHUB_TOKEN}`;
        }
        return headers;
      };

      let allProblems = [];
      let categories = ["All"];
      let currentCategory = "All";
      let currentSearch = "";

      window.onload = async () => {
        await initApp();
        lucide.createIcons();
      };

      async function initApp() {
        try {
          // 1. Gọi API lấy cấu trúc cây thư mục (Recursive)
          const response = await fetch(
            `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/git/trees/main?recursive=1`,
            { headers: getHeaders() }
          );

          // Cập nhật thông tin Rate Limit lên UI
          updateRateLimitDisplay(response.headers);

          if (!response.ok) {
            if (response.status === 403)
              throw new Error(
                "Rate limit exceeded. Hãy kiểm tra Token của bạn."
              );
            throw new Error(`Lỗi kết nối: ${response.status}`);
          }

          const data = await response.json();
          const tree = data.tree || [];

          allProblems = tree
            .filter((item) => item.type === "blob" && isCodeFile(item.path))
            .map((item) => {
              const pathParts = item.path.split("/");
              const categoryName =
                pathParts.length > 1 ? pathParts[pathParts.length - 2] : "Root";
              return {
                id: item.sha,
                title: pathParts[pathParts.length - 1]
                  .replace(/\.[^/.]+$/, "")
                  .replace(/[_-]/g, " "),
                fileName: pathParts[pathParts.length - 1],
                category: categoryName,
                fullPath: item.path,
                downloadUrl: `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${item.path}`,
                language: item.path.split(".").pop(),
              };
            });

          updateCategories();
          renderList();
          document.getElementById("loading-overlay").classList.add("hidden");
        } catch (err) {
          showError(err.message);
        }
      }

      function updateRateLimitDisplay(headers) {
        const remaining = headers.get("x-ratelimit-remaining");
        const limit = headers.get("x-ratelimit-limit");
        if (remaining) {
          const badge = document.getElementById("rate-limit-badge");
          const text = document.getElementById("rate-remaining");
          badge.classList.remove("hidden");
          text.innerText = `${remaining}/${limit}`;

          if (parseInt(remaining) < 100) {
            text.classList.replace("text-green-400", "text-red-400");
          }
        }
      }

      function isCodeFile(name) {
        const ext = name.split(".").pop().toLowerCase();
        return [
          "cpp",
          "py",
          "java",
          "pas",
          "c",
          "js",
          "txt",
          "md",
          "sql",
        ].includes(ext);
      }

      function updateCategories() {
        const cats = new Set(allProblems.map((p) => p.category));
        categories = ["All", ...Array.from(cats).sort()];

        const list = document.getElementById("category-list");
        list.innerHTML = categories
          .map(
            (cat) => `
                <button onclick="setCategory('${cat}')" class="w-full text-left px-4 py-2.5 rounded-xl text-sm transition-all flex justify-between items-center group ${
              currentCategory === cat
                ? "bg-indigo-50 text-indigo-700 font-bold shadow-sm"
                : "text-slate-600 hover:bg-slate-50"
            }">
                    <span class="truncate">${cat}</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 transition-opacity ${
                      currentCategory === cat
                        ? "opacity-100"
                        : "opacity-0 group-hover:opacity-100"
                    }"></i>
                </button>
            `
          )
          .join("");
        lucide.createIcons();
      }

      function renderList() {
        const container = document.getElementById("main-content");
        const filtered = allProblems.filter((p) => {
          const matchesSearch =
            p.title.toLowerCase().includes(currentSearch.toLowerCase()) ||
            p.fullPath.toLowerCase().includes(currentSearch.toLowerCase());
          const matchesCat =
            currentCategory === "All" || p.category === currentCategory;
          return matchesSearch && matchesCat;
        });

        if (filtered.length === 0) {
          container.innerHTML = `
                    <div class="py-24 text-center">
                        <i data-lucide="search" class="w-12 h-12 text-slate-300 mx-auto mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-700">Không tìm thấy kết quả</h3>
                    </div>`;
        } else {
          container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in duration-500">
                        ${filtered
                          .map(
                            (p) => `
                            <div onclick="showDetail('${p.id}')" class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 hover:shadow-xl hover:border-indigo-300 hover:-translate-y-1 transition-all cursor-pointer group flex flex-col justify-between">
                                <div>
                                    <div class="flex justify-between items-center mb-3">
                                        <span class="text-[9px] font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md uppercase tracking-widest shadow-sm">${p.category}</span>
                                        <span class="uppercase text-slate-400 text-[10px] font-bold">${p.language}</span>
                                    </div>
                                    <h3 class="font-bold text-slate-800 group-hover:text-indigo-600 transition-colors mb-2 text-lg line-clamp-2">${p.title}</h3>
                                </div>
                                <div class="flex items-center justify-between pt-4 border-t border-slate-50">
                                    <p class="text-[10px] text-slate-400 truncate max-w-[150px] font-mono italic">${p.fileName}</p>
                                    <span class="text-xs font-bold text-indigo-500 opacity-0 group-hover:opacity-100 transition-all flex items-center gap-1">
                                        Xem code <i data-lucide="chevron-right" class="w-4 h-4"></i>
                                    </span>
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>`;
        }
        lucide.createIcons();
      }

      async function showDetail(id) {
        const problem = allProblems.find((p) => p.id === id);
        const container = document.getElementById("main-content");

        container.innerHTML = `
                <div class="bg-white rounded-3xl shadow-md border border-slate-200 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-300">
                    <div class="p-6 md:p-8 border-b border-slate-100 bg-slate-50/50">
                        <button onclick="renderList()" class="mb-4 text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center gap-1 group transition-colors">
                            <span>←</span> Quay lại
                        </button>
                        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800 mb-2">${problem.title}</h2>
                                <p class="text-xs text-slate-400 font-mono mb-3">${problem.fullPath}</p>
                                <div class="flex gap-2">
                                    <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-[10px] font-bold uppercase">${problem.category}</span>
                                    <span class="px-3 py-1 bg-slate-200 text-slate-600 rounded-full text-[10px] font-bold uppercase">${problem.language}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="p-6 md:p-8">
                        <div class="bg-slate-800 text-slate-300 px-6 py-3 rounded-t-xl flex justify-between items-center text-[10px] font-mono border-b border-slate-700">
                            <span>MÃ NGUỒN</span>
                            <button onclick="copyCode()" id="copy-btn" class="flex items-center gap-2 hover:text-white transition-colors">
                                <i data-lucide="copy" size="14"></i> SAO CHÉP
                            </button>
                        </div>
                        <div class="bg-slate-900 p-6 rounded-b-xl overflow-x-auto min-h-[400px]">
                            <pre id="code-display" class="text-indigo-300 font-mono text-sm leading-relaxed tab-size-4"><code>Đang tải...</code></pre>
                        </div>
                    </div>
                </div>`;

        lucide.createIcons();

        try {
          // Khi lấy raw file nội dung lớn, Token cũng giúp tránh bị throttle
          const res = await fetch(problem.downloadUrl, {
            headers: getHeaders(),
          });
          const code = await res.text();
          document.getElementById("code-display").innerText = code;
          window.currentCode = code;
        } catch (e) {
          document.getElementById("code-display").innerText =
            "// Lỗi khi tải nội dung từ GitHub Raw.";
        }
      }

      function copyCode() {
        if (!window.currentCode) return;

        const textArea = document.createElement("textarea");
        textArea.value = window.currentCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand("copy");
        document.body.removeChild(textArea);

        const btn = document.getElementById("copy-btn");
        btn.innerHTML = `<i data-lucide="check" class="text-green-400" size="14"></i> ĐÃ CHÉP`;
        lucide.createIcons();
        setTimeout(() => {
          btn.innerHTML = `<i data-lucide="copy" size="14"></i> SAO CHÉP`;
          lucide.createIcons();
        }, 2000);
      }

      function setCategory(cat) {
        currentCategory = cat;
        updateCategories();
        renderList();
      }

      function handleSearch(val) {
        currentSearch = val;
        renderList();
      }

      function goHome() {
        currentCategory = "All";
        currentSearch = "";
        document.getElementById("search-input").value = "";
        updateCategories();
        renderList();
      }

      function showError(msg) {
        document.getElementById("main-content").innerHTML = `
                <div class="p-12 text-center bg-white rounded-3xl border border-red-100 shadow-sm">
                    <i data-lucide="alert-circle" class="w-12 h-12 text-red-500 mx-auto mb-4"></i>
                    <h3 class="text-lg font-bold text-slate-800">Lỗi GitHub API</h3>
                    <p class="text-slate-500 mt-2 text-sm">${msg}</p>
                    <button onclick="window.location.reload()" class="mt-6 px-6 py-2 bg-indigo-600 text-white rounded-xl text-sm font-bold">Thử lại</button>
                </div>`;
        document.getElementById("loading-overlay").classList.add("hidden");
        lucide.createIcons();
      }
    </script>
  </body>
</html>
